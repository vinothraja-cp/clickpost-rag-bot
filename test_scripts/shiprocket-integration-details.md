## Scope \& components

This integration covers Shiprocket order creation (including pickup-location/vendor creation), cancellation, NDR updates (RTO + reattempt/defer/edit), and tracking checkpoint normalization for Clickpost.
The implementation is split across `shiprocket_order_creation.py` (orchestration), `shiprocket_obj_builder.py` (payload building), and `shiprocket_service.py` (HTTP calls + response parsing).

## Authentication \& environment

Shiprocket API calls use token-based **Bearer** authentication via the `Authorization: Bearer <token>` header, along with `Content-Type: application/json`.
A token is generated by POSTing `email` and `password` to the login endpoint (`/v1/external/auth/login`) and reading `token` from the JSON response.
On HTTP 401/402/403 during certain API calls (order creation, pickup creation), the code regenerates the token and retries the request.

Environment selection is driven by `CourierPartnerEnvironmentTypeEnum` (TEST/PRODUCTION) and is used when constructing some URLs via `fetch_courier_partner_service_url(..., CourierPartnerServiceTypeEnum.AUTHORIZATION)`.

## Base URLs \& endpoints

`SHIPROCKET_BASE_URL` is set to `https://apiv2.shiprocket.in`.
Some endpoints are built using `SHIPROCKET_BASE_URL`, while others are built using `auth_base_url = fetch_courier_partner_service_url(... AUTHORIZATION ...)` depending on the flow.


| Flow | Method | URL (as built in code) | Auth header | Notes |
| :-- | :-- | :-- | :-- | :-- |
| Token generation | POST | `auth_base_url + /v1/external/auth/login`  | None (no Bearer), only `Content-Type: application/json`  | Payload: `{ "email": ..., "password": ... }`  |
| Pickup location (vendor) create | POST | `SHIPROCKET_BASE_URL + /v1/external/settings/company/addpickup`  | `Authorization: Bearer <token>`  | Retries on 401/402/403 after token regeneration.  |
| Create order (forward shipment) | POST | `SHIPROCKET_BASE_URL + /v1/external/shipments/create/forward-shipment`  | `Authorization: Bearer <token>`  | Timeout defaults to 15s; 20s for enterprises SNITCH and PHARMEASY_PROD.  |
| Failed-case recovery: search shipment | GET | `SHIPROCKET_BASE_URL + /v1/external/orders?search=<awb>`  | `Authorization: Bearer <token>`  | Used when `status == 0` and response payload includes `awb_code`.  |
| Failed-case recovery: generate label | POST | `SHIPROCKET_BASE_URL + /v1/external/courier/generate/label`  | `Authorization: Bearer <token>`  | Payload: `{ "shipment_id": ["<id>"] }` using shipment `id` from search.  |
| Cancel via NDR “return” | POST | `SHIPROCKET_BASE_URL + /v1/external/ndr/<waybill>/action`  | `Authorization: Bearer <token>` (newly generated in `cancelAPI`)  | Body: `{ "action": "return", "comments": "The Buyer doesn't want the product" }`.  |
| Cancel order by order id | POST | `auth_base_url + /v1/external/orders/cancel`  | `Authorization: Bearer <token>`  | Body: `{ "ids": [<order_id_int>] }`; treats “already cancelled” message as success.  |
| Cancel order by AWB | POST | `auth_base_url + /v1/external/orders/cancel/shipment/awbs`  | `Authorization: Bearer <token>`  | Body: `{ "awbs": [<awb>] }`; some “cancellation in progress” messages treated as success.  |
| NDR reattempt/edit/defer | POST | `SHIPROCKET_BASE_URL + /v1/external/ndr/<waybill>/action`  | `Authorization: Bearer <token>` (refreshed via `update_auth_token`)  | Payload includes `action: re-attempt`, `comments`, and optionally `address1`, `phone`, `deferred_date`.  |

## Clickpost ↔ Shiprocket payload mapping

Order creation builds a Shiprocket “forward shipment” payload using Clickpost’s `order_creation_dict` plus items extracted from the incoming `request_dict` via `get_items_from_request_dict(request_dict)`.
Pickup location creation (vendor) builds a Shiprocket pickup payload using Clickpost pickup/address fields and the internally assigned pickup identifier (`vendor_code` / `pickup_location`).

### A) Pickup location (vendor) payload

Shiprocket pickup payload is produced by `build_vendor_obj(vendor_code, address_obj, enterprise_profile_id)`.


| Shiprocket field | Clickpost source / logic |
| :-- | :-- |
| `pickup_location` | `str(vendor_code)` where `vendor_code` is the `CourierPartnerAddressLink.id` when building the payload.  |
| `name` | `address_obj['name']` (trimmed).  |
| `email` | `address_obj['email']` (trimmed).  |
| `phone` | `address_obj['phone']` (trimmed).  |
| `address` / `address_2` | `AddressService.break_address_in_lines(address_obj['address'], line_length=80, num_lines=2)` -> index 0/1.  |
| `city` / `state` / `country` | `address_obj['city']`, `address_obj['state']`, `address_obj['country']`.  |
| `pin_code` | `address_obj['pin_code']`.  |

Vendor code resolution flow in order creation:

- If `order_creation_dict` already includes `vendor_code`, it is used directly.
- Otherwise, the code tries to fetch a `CourierPartnerAddressLink` using pickup address fields, and if missing, creates it, then calls Shiprocket “addpickup” to register the pickup location and stores the resulting `vendor_code` back on the link.


### B) Order creation (“forward shipment”) payload

Shiprocket order payload is produced by `build_shipping_object(request_dict, shiprocket_creds, order_creation_dict, vendor_code)`.


| Shiprocket field | Clickpost source / logic |
| :-- | :-- |
| `mode` | `shiprocket_creds['shipping_mode']`.  |
| `print_label` | Hardcoded `True`.  |
| `order_id` | Defaults to `order_creation_dict['reference_number']`, but can switch based on `shiprocket_creds['order_number_format']` to `order_creation_dict['order_id']` or `"order_id_referenceNumber"`.  |
| `order_date` | `datetime.now().strftime('%Y-%m-%d')`.  |
| `channel_id` | `shiprocket_creds['channel_id']`.  |
| `billing_customer_name` | `alphanumeric_characters_only(order_creation_dict['drop_name'])`.  |
| `billing_last_name` | Hardcoded `""`.  |
| `billing_address` | `order_creation_dict['drop_address'][:80]`.  |
| `billing_address_2` | `order_creation_dict['drop_address'][80:160]`.  |
| `billing_city` | `order_creation_dict['drop_city'][:30]`.  |
| `billing_state` / `billing_country` | `order_creation_dict['drop_state']` / `order_creation_dict['drop_country']`.  |
| `billing_pincode` | `order_creation_dict['drop_pincode']`.  |
| `billing_email` | `order_creation_dict['drop_email']` if present else `""`.  |
| `billing_phone` | `order_creation_dict['drop_phone']`.  |
| `shipping_is_billing` | Hardcoded `True`.  |
| `order_items` | Built from `get_items_from_request_dict(request_dict)` into `[{sku,name,units,selling_price}, ...]`.  |
| `payment_method` | `"COD"` if `order_creation_dict['order_type']=="COD"` else `"Prepaid"` if `"PREPAID"`.  |
| `weight` | `str(round(float(order_creation_dict['weight'])/1000, 3))`.  |
| `length` / `breadth` / `height` | `int(order_creation_dict['length'/'breadth'/'height'])` (with enterprise overrides for URBANIC/SAVANA).  |
| `pickup_location` | `str(vendor_code)` (resolved/created earlier).  |
| `sub_total` | For COD: `round(float(order_creation_dict['cod_value']),2)`; for PREPAID: `invoice_value` (with LOUISSTITCH zero-handling) then rounded.  |
| `order_type` | `str(shiprocket_creds['order_type'])`.  |
| `courier_id` (optional) | Set if `shiprocket_creds['courier_id']` is present.  |
| `invoice_number` (conditional) | Added for WELLBEING_NUTRITION as `order_creation_dict['invoice_number']`.  |
| Enterprise custom fields (conditional) | MIGLOWSTORE/RECODESTUDIOS: may add `total_discount`, `shipping_charges`, override `sub_total`; CURESKIN: may set `order_tag`; TRUEMEDS: forces `weight='0.5'`.  |

Item mapping rules (per item):

- `sku`: from item `sku` (if present), with de-duplication by appending `-1`, `-2`, etc., and truncated to 50 chars.
- `name`: from item `description`, truncated to 200 chars.
- `units`: `int(item['quantity'])`.
- `selling_price`: usually `float(item['price'])`, with enterprise-specific overrides for PRISTYNCARE and PHARMEASY.


## Webhook \& tracking normalization

Webhook path documented in the file is `/api/v1/tracking_webhook/rocket`, described as “Shiprocket send to us.”
Tracking conversion expects a Shiprocket response containing `scans`, `shipment_status_id`, `current_timestamp`, `current_status`, `partner_id`, and optionally `etd`, then emits Clickpost checkpoints with normalized timestamps via `get_standard_timestamp(...)`.
If `shipment_status_id` is one of `['8','12','13','7']` and scans are empty/missing, the code synthesizes a checkpoint using `current_timestamp` parsed as `"%d %m %Y %H:%M:%S"` and `current_status`.